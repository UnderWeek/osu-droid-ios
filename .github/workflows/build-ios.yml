name: Build iOS IPA

on:
  push:
    branches: [main, ios-port]
    paths:
      - 'iosApp/**'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [main]
    paths:
      - 'iosApp/**'
  workflow_dispatch:

jobs:
  build:
    name: Build unsigned IPA
    runs-on: macos-15
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List available Xcode versions
        run: ls /Applications/ | grep Xcode

      - name: Select Xcode
        run: |
          # Pick latest available Xcode
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          echo "Using: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"
          xcodebuild -version
          swift --version

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Copy game assets to iOS resources
        run: |
          mkdir -p iosApp/osu-droid/Resources/GFX
          mkdir -p iosApp/osu-droid/Resources/SFX
          mkdir -p iosApp/osu-droid/Resources/Fonts

          cp assets/gfx/*.png iosApp/osu-droid/Resources/GFX/ 2>/dev/null || true
          cp assets/sfx/*.ogg iosApp/osu-droid/Resources/SFX/ 2>/dev/null || true
          cp assets/fonts/*.otf iosApp/osu-droid/Resources/Fonts/ 2>/dev/null || true
          cp assets/fonts/*.ttf iosApp/osu-droid/Resources/Fonts/ 2>/dev/null || true
          cp assets/logo.png iosApp/osu-droid/Resources/ 2>/dev/null || true

          echo "Assets copied: $(find iosApp/osu-droid/Resources -type f | wc -l) files"

      - name: Generate Xcode project
        working-directory: iosApp
        run: |
          xcodegen generate
          echo "Project generated. Schemes:"
          xcodebuild -project osu-droid.xcodeproj -list

      - name: Build archive
        working-directory: iosApp
        run: |
          xcodebuild archive \
            -project osu-droid.xcodeproj \
            -scheme osu-droid \
            -configuration Release \
            -archivePath build/osu-droid.xcarchive \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="-" \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=NO \
            2>&1 | tee build.log

          # Check if archive was created
          if [ ! -d "build/osu-droid.xcarchive" ]; then
            echo "::error::Archive not created. Last 100 lines of build log:"
            tail -100 build.log
            exit 1
          fi

      - name: Create unsigned IPA
        run: |
          # Find the .app bundle
          echo "Archive contents:"
          find iosApp/build/osu-droid.xcarchive -name "*.app" -type d

          APP_PATH=$(find iosApp/build/osu-droid.xcarchive -name "*.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "::error::.app bundle not found in archive"
            echo "Full archive structure:"
            find iosApp/build/osu-droid.xcarchive -type f | head -50
            exit 1
          fi

          echo "Found app at: $APP_PATH"

          # Create Payload directory and IPA
          mkdir -p iosApp/build/Payload
          cp -r "$APP_PATH" iosApp/build/Payload/
          cd iosApp/build
          zip -r -q osu-droid-unsigned.ipa Payload

          echo "IPA created:"
          ls -lh osu-droid-unsigned.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: osu-droid-ios
          path: iosApp/build/osu-droid-unsigned.ipa
          retention-days: 30
          if-no-files-found: error

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: iosApp/build.log
          retention-days: 7
          if-no-files-found: warn
